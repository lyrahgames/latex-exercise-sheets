\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{ati}[2017/07/05 Abstract Task Interface v0.1]

\RequirePackage{enumitem}
\RequirePackage{marginnote}
\RequirePackage{exsheets}

\RequirePackage[autostyle=true,german=guillemets]{csquotes}

% \RequirePackage{atimathsym}
\RequirePackage{utilities}
\RequirePackage{uniinput}

\RequirePackage{multienum}
\RequirePackage{comment}


\DeclareOption{pgfkeys}{
	\def\atiKeySystem{pgfkeys}
	\AtEndOfPackage{\RequirePackage{pgfkeys}}

	\pgfkeys{
		/ati/.style = /ati/.cd,
		ati,
		.unknown/.code = ,
		task/.style = /ati/task/.cd,
		task,
		.unknown/.code = ,
		call/.initial = Aufgabe,
		title/.estore in = \atiTaskTitle,
		title/.default = ,
		language/.estore in = \atiTaskLanguage,
		language/.default = Deutsch,
		points/.estore in = \atiTaskPoints,
		points/.default = 0,
		topic/.estore in = \atiTaskTopic,
		topic/.default = ,
		subtopic/.estore in = \atiTaskSubtopic,
		subtopic/.default = ,
	}
}

\DeclareOption{exsheets}{
	\def\atiTaskSystem{exsheets}
	\AtEndOfPackage{\RequirePackage{exsheets}}

	\DeclareInstance{exsheets-heading}{block-subtitle}{default}{
		join = {
			title[r,B]number[l,B](0.333em,0pt);
			title[r,B]subtitle[l,B](1em,0pt)
		},
		attach = {
			main[l,vc]title[l,vc](0pt,0pt);
			main[r,vc]points[l,vc](\marginparsep,0pt)
		}
	}

	% \SetupExSheets{headings=block-subtitle, solution/print=true}
	\SetupExSheets{headings=block-subtitle}

	\newenvironment{atiTask}[1][]{
		\pgfkeys{ati/task,title,points,#1}
		\question[subtitle=\atiTaskTitle]{\atiTaskPoints}
	}{
		% \end{question}
		\endquestion
	}

	\newenvironment{atiSolution}{
		\solution
	}{
		\endsolution
	}
}

\DeclareOption{custom}{
	\def\atiTaskSystem{custom}

	\newcounter{atiTaskCounter}

	\newenvironment{atiTask}[1][]{
		\setlength\parindent{0mm}
		\pgfkeys{ati/task,points,#1}
		\refstepcounter{atiTaskCounter}
		\newcommand\locallabel[1]{\label{ati:\theatiTaskCounter:##1}}
		\newcommand\localref[1]{\ref{ati:\theatiTaskCounter:##1}}
		\bigskip\par%
		{
			\large%
			\textbf{%
				\pgfkeysvalueof{/ati/task/call}
				\theatiTaskCounter
			}
		}
		\hfill
		\ifdefined\atiTaskTitle
			\textit{\atiTaskTitle}%
			\nopagebreak[4]
		\fi%
		% \marginnote{\atiShowPoints{\atiTaskPoints}}
		% \medskip%
		\par\medskip%
		% \begin{samepage}
	}{
		% \end{samepage}
		% \bigskip\par
		% \footnotesize
		% topic: \atiTaskTopic \\
		% subtopic: \atiTaskSubtopic \\
		% language: \atiTaskLanguage
		\bigskip\par
	}

	\newif\ifatiShowSolutions
	\atiShowSolutionstrue
	\ifatiShowSolutions
		\newenvironment{atiSolution}{
			% \ifatiShowSolutions
				\setlength\parindent{0mm}
				\newcommand\locallabel[1]{\label{ati:\theatiTaskCounter:##1}}
				\newcommand\localref[1]{\ref{ati:\theatiTaskCounter:##1}}
				\bigskip\par%
				\noindent%
				{
					% \noindent%
					\large%
					\textsc{%
						LÃ¶sung:
					}
				}
				\hfill
				\medskip
				\par
			% \else
			% 	\comment
			% \fi
		}{
			% \ifatiShowSolutions
				\bigskip
				\par
			% \else
			% 	\endcomment
			% \fi
		}
	\else
		\excludecomment{atiSolution}
	\fi
}


% \ExecuteOptions{pgfkeys,custom}
\ProcessOptions\relax


\newenvironment{atiSubtasks}{%
	% \begin{enumerate}[label=\normalfont(\alph*), topsep=0pt]
	\begin{enumerate}[label=\normalfont(\alph*)]
}{%
	\end{enumerate}
}

\newenvironment{atiSubsubtasks}{%
	% \begin{enumerate}[label=\normalfont(\arabic*), topsep=0pt]
	\begin{enumerate}[label=\normalfont(\arabic*)]
}{%
	\end{enumerate}
}

\newenvironment{atiNote}{%
	\medskip\textbf{Hinweis:}
}{%

}

\newenvironment{atiSubtaskSolutions}{
	\begin{description}[style=multiline]
}{
	\end{description}
}

\newenvironment{atiSubequations}{
	\begin{enumerate}[label=\normalfont(\roman*)]
	\let\olditem\item
	\def\item##1{\olditem \ensuremath{ \qquad \begin{aligned}[t] ##1 \end{aligned} } }
}{
	\end{enumerate}
}

\newenvironment{atiItems}{
	\begin{itemize}
}{
	\end{itemize}
}

\newcounter{atiPointsCounter}
\newcommand{\atiPointsPrefix}{}
\newcommand{\atiPointsSuffix}{~P.}
\newcommand{\atiPoints}[1][1]{\marginnote{\atiPointsPrefix\ensuremath{#1}\atiPointsSuffix}\refstepcounter{atiPointsCounter}}

\newcommand{\atiShowPoints}[1]{\atiPointsPrefix#1\atiPointsSuffix}

\newcommand{\atiPointsCount}{\marginnote{\rule{1cm}{0.5pt}\\ \atiPointsPrefix\theatiPointsCounter\atiPointsSuffix}}

\endinput